<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  </head>
  <body>
    <div class="row">
      <div class="col-4">
        <div id="createNewUser">
          <h1>Create new User</h1>
          <input
            type="text"
            id="createNewUserUsername"
            placeholder="Username"
          />
          <input
            type="text"
            id="createNewUserFirstName"
            placeholder="First Name"
          />
          <input
            type="text"
            id="createNewUserLastName"
            placeholder="Last Name"
          />
          <input
            type="number"
            id="createNewUserBirthdate"
            placeholder="Birth Date"
          />

          <button class="btn btn-primary" onclick="createNewUser()">
            Create
          </button>
        </div>

        <div id="users">
          <h1>User List</h1>
          <div>
            <ul class="list-group" id="userList"></ul>
          </div>
        </div>
      </div>

      <div class="col-4">
        <div>
          <div class="input-group" id="login">
            <input type="text" id="loginUserid" placeholder="User id" />
            <button class="btn btn-primary" onclick="login()">Log In</button>
          </div>

          <h1>User details</h1>
          <p id="loginUsername"></p>
          <p id="loginFirstname"></p>
          <p id="loginLastname"></p>
          <p id="loginBirthdate"></p>
        </div>

        <div id="friends">
          <h1>Friends</h1>
          <div class="input-group" id="sendFriend">
            <input type="text" id="sendFriendUserid" placeholder="User id" />
            <button class="btn btn-primary" onclick="askFriend()">
              Ask Friend
            </button>
          </div>
          <div>
            <ul class="list-group" id="friendList"></ul>
          </div>
        </div>
      </div>

      <div class="col-4">
        <h1>contact: <span id="chatContact"></span></h1>
        <div>
          <ul class="list-group" id="chatMessages"></ul>
        </div>
        <div class="input-group" id="chatSendMessage">
          <input
            type="text"
            id="chatSendMessageText"
            placeholder="Write a message"
          />
          <button class="btn btn-primary" onclick="writeMessage()">Send</button>
        </div>
      </div>
    </div>
    <script>
      async function createNewUser() {
        var user = {
          username: document.getElementById("createNewUserUsername").value,
          firstname: document.getElementById("createNewUserFirstName").value,
          lastname: document.getElementById("createNewUserLastName").value,
          birthdate: document.getElementById("createNewUserBirthdate").value,
        };
        var url = "/user";
        var userform = await sendRequest(url, "POST", user, "JSON");
        getUsers();
      }

      async function getUsers() {
        var url = "/users";
        var users = await sendRequest(url, "GET");

        var userList = document.getElementById("userList");

        // clear userlist
        userList.innerHTML = "";

        users.forEach((user) => {
          var listelement = document.createElement("li");
          listelement.classList.add("list-group-item");

          var username = document.createElement("p");
          var id = document.createElement("p");
          username.innerHTML = "Username: " + user.username;
          id.innerHTML = "id: " + user.id;

          listelement.appendChild(username);
          listelement.appendChild(id);

          userList.appendChild(listelement);
        });
      }

      var currentUserid = 0;

      async function login() {
        currentUserid = document.getElementById("loginUserid").value;

        var url = "/user/" + currentUserid;
        var user = await sendRequest(url, "GET");

        document.getElementById("loginUsername").innerHTML =
          "Username: " + user.username;
        document.getElementById("loginFirstname").innerHTML =
          "Firstname: " + user.firstname;
        document.getElementById("loginLastname").innerHTML =
          "Lastname: " + user.lastname;
        document.getElementById("loginBirthdate").innerHTML =
          "Birthdate: " + user.birthdate;

        getFriends();
        connectWebsocket();
        currentContactid = 0;
        document.getElementById("chatMessages").innerHTML = "";
        document.getElementById("chatContact").innerHTML = "";
      }

      async function getFriends() {
        var url = "/friend/" + currentUserid;
        var friends = await sendRequest(url, "GET");
        var friendList = document.getElementById("friendList");

        // clear friendlist
        friendList.innerHTML = "";

        friends.forEach(async (relation) => {
          var friendid =
            currentUserid == relation.senderid
              ? relation.recieverid
              : relation.senderid;
          var url = "/user/" + friendid;
          var user = await sendRequest(url, "GET");

          var listelement = document.createElement("li");
          listelement.classList.add("list-group-item");
          listelement.classList.add("text-white");
          if (relation.status == 1) {
            listelement.classList.add("bg-success");
          } else {
            listelement.classList.add("bg-warning");
          }
          listelement.id = friendid;
          listelement.onclick = function () {
            openChat(this.id);
          };

          var username = document.createElement("p");
          var id = document.createElement("p");
          var status = document.createElement("p");
          username.innerHTML = "Username: " + user.username;
          id.innerHTML = "id: " + user.id;
          status.innerHTML = "status: " + relation.status;

          listelement.appendChild(username);
          listelement.appendChild(id);
          listelement.appendChild(status);

          if (relation.status == 0 && relation.recieverid == currentUserid) {
            var acceptBtn = document.createElement("button");
            acceptBtn.classList.add("btn");
            acceptBtn.classList.add("btn-primary");
            acceptBtn.innerHTML = "Accept";
            acceptBtn.id = friendid;

            acceptBtn.onclick = function () {
              answerFriend(true, this.id, currentUserid);
            };

            var declineBtn = document.createElement("button");
            declineBtn.classList.add("btn");
            declineBtn.classList.add("btn-primary");
            declineBtn.innerHTML = "Decline";
            declineBtn.id = friendid;

            declineBtn.onclick = function () {
              answerFriend(false, this.id, currentUserid);
            };

            listelement.appendChild(acceptBtn);
            listelement.appendChild(declineBtn);
          }

          friendList.appendChild(listelement);
        });
      }

      async function askFriend() {
        var user = {
          senderid: currentUserid,
          recieverid: document.getElementById("sendFriendUserid").value,
        };
        var url = "/friend";
        var userform = await sendRequest(url, "POST", user, "JSON");
        getFriends();
      }

      async function answerFriend(accepted, senderid, recieverid) {
        var answer = {
          senderid: senderid,
          recieverid: recieverid,
          accepted: accepted,
        };

        var url = "/friend";
        await sendRequest(url, "PUT", answer, "JSON");
        getFriends();
      }

      var currentContactid = 0;

      function openChat(friendid) {
        currentContactid = friendid;
        document.getElementById("chatContact").innerHTML = currentContactid;
        getMessages();
      }

      async function getMessages() {
        var url = "/conversation/" + currentUserid + "/" + currentContactid;
        var messages = await sendRequest(url, "GET");

        var chatList = document.getElementById("chatMessages");

        //clear messages
        chatList.innerHTML = "";

        messages.forEach((message) => {
          var listelement = document.createElement("li");
          listelement.classList.add("list-group-item");
          if (message.senderid == currentUserid) {
            listelement.classList.add("bg-primary");
            listelement.classList.add("text-white");
          }
          var text = document.createElement("p");

          text.innerHTML = "text: " + message.message;

          listelement.appendChild(text);

          chatList.appendChild(listelement);
        });
      }

      async function writeMessage() {
        var body = {
          senderid: currentUserid,
          recieverid: currentContactid,
          message: document.getElementById("chatSendMessageText").value,
        };

        var url = "/message";
        await sendRequest(url, "POST", body, "JSON");

        getMessages();
      }

      function getArchieveMessages() {}

      var websocketClient = null;

      function connectWebsocket() {
        if (websocketClient) {
          websocketClient.close();
        }
        websocketClient = new WebSocket("ws://localhost/websocket");

        websocketClient.onopen = (event) => {
          websocketClient.send(currentUserid + "");
        };

        websocketClient.onmessage = (event) => {
          console.log(event.data);
          getMessages();
        };
      }

      function sendRequest(url, type, data, datatype) {
        var res = $.ajax({
          type: type,
          url: url,
          data: data,
          dataType: datatype,
          success: function (res) {
            return res;
          },
          error: function (err) {
            return err;
          },
        });

        return res.catch((err) => {
          console.log(err);
        });
      }
    </script>
    <script>
      getUsers();
    </script>
  </body>
</html>
